# SAL - Media Center Arti Marziali
## Stato Avanzamento Lavori al 29/11/2024

---

## 1. ARCHITETTURA SISTEMA

### Backend (FastAPI - Porta 8100)
- **Framework**: FastAPI con Uvicorn
- **Database**: SQLAlchemy async (SQLite/PostgreSQL ready)
- **Path**: `backend/`

### Frontend (Next.js 14 - Porta 3200)
- **Framework**: Next.js 14 App Router
- **Styling**: Tailwind CSS
- **Path**: `frontend/`

### Servizi Video Studio
- **Path**: `backend/services/video_studio/`
- **Moduli disponibili**:
  - `skeleton_extraction_holistic.py` - MediaPipe Holistic (75 landmarks)
  - `ingest_orchestrator.py` - Pipeline completa di processing
  - `motion_analyzer.py` - Analisi movimento
  - `voice_cloner.py` - Clonazione voce
  - `knowledge_extractor.py` - Estrazione conoscenza
  - `technique_extractor.py` - Estrazione tecniche
  - `blender_export.py` - Export per Blender

---

## 2. FUNZIONALITA' COMPLETATE

### 2.1 Endpoint Backend Implementati

| Endpoint | Metodo | Descrizione | Stato |
|----------|--------|-------------|-------|
| `/api/v1/videos/ingest` | POST | Upload video con estrazione skeleton | FUNZIONANTE |
| `/api/v1/videos/skeletons` | GET | Lista skeleton estratti | FUNZIONANTE |
| `/api/v1/videos/ingest/status/{id}` | GET | Stato elaborazione ingest | FUNZIONANTE |
| `/health` | GET | Health check backend | FUNZIONANTE |

### 2.2 Proxy Frontend (Next.js API Routes)

| Route Frontend | Backend Target | Stato |
|----------------|----------------|-------|
| `/api/ingest` | `/api/v1/videos/ingest` | FUNZIONANTE |
| `/api/studio/skeletons` | `/api/v1/videos/skeletons` | FUNZIONANTE |

### 2.3 Estrazione Skeleton MediaPipe

- **Modello**: MediaPipe Holistic (complexity=1)
- **Landmarks**: 75 totali
  - 33 body pose landmarks
  - 21 left hand landmarks
  - 21 right hand landmarks
- **Output**: JSON con coordinate normalizzate per frame
- **Performance testata**: ~5.65 fps su CPU (video 640x360)
- **Test completato**: Video 117s, 2338 frames -> 413s elaborazione

### 2.4 Pagine Frontend Esistenti

| Pagina | Path | Descrizione |
|--------|------|-------------|
| Dashboard | `/` | Home con stato backend e statistiche |
| Unified Ingest | `/ingest` | Upload multi-formato |
| Voice Cloning | `/voice-cloning` | Clonazione voce |
| Motion Analysis | `/pose-detection` | Pose detection real-time |
| Technique Annotation | `/technique-annotation` | Annotazione tecniche AI |
| Technique Comparison | `/technique-comparison` | Confronto tecniche |
| AI Translation | `/translation` | Traduzione con dizionario arti marziali |
| Processing Monitor | `/monitor` | Monitor elaborazione real-time |
| Skeleton Library | `/skeletons` | Libreria skeleton estratti |
| Skeleton Viewer | `/skeleton-viewer` | Visualizzatore skeleton |

---

## 3. DATI DI TEST

### Video Caricati
```
data/uploads/
├── 7e953a18-3997-4208-9f21-6d2eb21137f5.mp4
├── cb4e8bdd-bbac-4e7e-9f02-01030565167f.mp4
├── d787b60a-ac9b-450c-8191-e1cfdd6e653a.mp4
└── 9c62c9d7-cad6-4c47-b7fb-fc3aeff659f8.mp4 (nuovo da test)
```

### Skeleton Estratti
```
data/skeletons/
└── 9c62c9d7-cad6-4c47-b7fb-fc3aeff659f8_skeleton.json (29.6 MB, 2338 frames)
```

---

## 4. CONFIGURAZIONE

### API Config (`frontend/src/config/api.ts`)
```typescript
STREAMING: { baseURL: 'http://localhost:8100', port: 8100 }
STUDIO: { baseURL: 'http://localhost:8100', port: 8100 }
LIBRARY: { baseURL: 'http://localhost:8100', port: 8100 }
AUTH: { baseURL: 'http://localhost:8100', port: 8100 }
```

### Dipendenze Chiave
- `mediapipe==0.10.21` (installato)
- `opencv-python` (installato)
- `fastapi`, `uvicorn`, `sqlalchemy`

---

## 5. FIX APPLICATI OGGI (29/11/2024)

1. **postcss.config.js** - Creato file mancante per Tailwind CSS
2. **API_CONFIG** - Aggiornato da porta 8000 a 8100
3. **Route `/api/ingest`** - Creato proxy Next.js per ingest
4. **Route `/api/studio/skeletons`** - Creato proxy Next.js per skeleton list
5. **Endpoint `/skeletons`** - Spostato PRIMA di `/{video_id}` per fix routing FastAPI
6. **MediaPipe** - Installato dopo pulizia cache pip (677 MB liberati)
7. **Integrazione Skeleton Extraction** - Collegato all'endpoint ingest

---

## 6. COSA MANCA / TODO

### 6.1 Alta Priorità

- [ ] **Visualizzatore Skeleton** - Implementare player skeleton con canvas/WebGL
- [ ] **Skeleton su video esistenti** - Batch processing per i 3 video già caricati
- [ ] **Progress WebSocket** - Real-time progress durante estrazione (attualmente sincrono)
- [ ] **Database persistence** - Salvare metadata skeleton su DB (ora solo filesystem)

### 6.2 Media Priorità

- [ ] **Voice Cloning Integration** - Collegare `voice_cloner.py` agli endpoint
- [ ] **Technique Extraction** - Collegare `technique_extractor.py`
- [ ] **Knowledge Extraction** - Collegare `knowledge_extractor.py`
- [ ] **Blender Export** - Endpoint per export skeleton in formato Blender
- [ ] **Confronto Skeleton** - Comparazione tra due skeleton per similarity

### 6.3 Bassa Priorità

- [ ] **GPU Acceleration** - MediaPipe con CUDA per performance migliori
- [ ] **Batch Upload** - Upload multipli contemporanei con queue
- [ ] **Autenticazione** - Sistema auth per staff
- [ ] **Fix router mancanti** - `ads`, `blockchain`, `Library` (errori non bloccanti)

### 6.4 Bug Noti

- **Library router**: `No module named 'backend'` - import path errato
- **Ads/Blockchain routers**: Moduli non implementati (warning non bloccante)
- **STRIPE_SECRET_KEY**: Non configurato (funzionalità pagamenti disabilitata)

---

## 7. COMANDI UTILI

### Avvio Backend
```bash
cd backend
venv\Scripts\python.exe -m uvicorn main:app --host 0.0.0.0 --port 8100 --reload
```

### Avvio Frontend
```bash
cd frontend
npm run dev -- -p 3200
```

### Test Endpoint
```bash
# Lista skeleton
curl http://localhost:8100/api/v1/videos/skeletons

# Upload con estrazione
curl -X POST http://localhost:8100/api/v1/videos/ingest \
  -F "files=@video.mp4" \
  -F "extract_skeleton=true"

# OpenAPI docs
http://localhost:8100/docs
```

---

## 8. BACKUP

Backup dei file modificati disponibile in:
```
media-center-arti-marziali/backup_20241129/
├── videos.py
├── api.ts
├── page.tsx
├── postcss.config.js
├── ingest/
└── studio/
```

---

## 9. PROSSIMI STEP CONSIGLIATI

1. **Testare frontend** nel browser (`http://localhost:3200`)
2. **Verificare skeleton viewer** funzionante
3. **Estrarre skeleton** per i video già caricati
4. **Implementare WebSocket** per progress real-time
5. **Collegare altri moduli** video_studio (voice, technique, knowledge)

---

*Documento generato il 29/11/2024 alle 12:40*
