# ========================================
# PRODUCTION DOCKER COMPOSE
# Media Center Arti Marziali - Full Stack
# ========================================
#
# Services:
# - nginx: Reverse proxy + SSL termination
# - backend: FastAPI application (4 workers)
# - frontend: Next.js application
# - postgres: PostgreSQL database
# - redis: Cache & Celery broker
# - celery-worker: Background tasks
# - celery-beat: Scheduled tasks
#
# Usage:
#   docker-compose -f docker-compose.prod.yml up -d
#   docker-compose -f docker-compose.prod.yml logs -f
#   docker-compose -f docker-compose.prod.yml down
#
# ========================================

version: '3.8'

services:
  # ========================================
  # NGINX - Reverse Proxy + SSL
  # ========================================
  nginx:
    image: nginx:alpine
    container_name: martial_arts_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.prod.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - nginx-logs:/var/log/nginx
    depends_on:
      - backend
      - frontend
    restart: always
    networks:
      - martial-arts-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ========================================
  # BACKEND - FastAPI Application
  # ========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    container_name: martial_arts_backend
    env_file:
      - .env.production
    environment:
      - ENV=production
      - DATABASE_URL=postgresql://martial_user:${DB_PASSWORD}@postgres:5432/martial_arts_prod
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/1
    volumes:
      - backend-logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: always
    networks:
      - martial-arts-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ========================================
  # FRONTEND - Next.js Application
  # ========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    container_name: martial_arts_frontend
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=${BACKEND_URL}
    restart: always
    networks:
      - martial-arts-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ========================================
  # POSTGRESQL - Database
  # ========================================
  postgres:
    image: postgres:15-alpine
    container_name: martial_arts_postgres
    environment:
      POSTGRES_DB: martial_arts_prod
      POSTGRES_USER: martial_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    restart: always
    networks:
      - martial-arts-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U martial_user -d martial_arts_prod"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    command:
      - "postgres"
      - "-c"
      - "max_connections=100"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=1GB"
      - "-c"
      - "maintenance_work_mem=64MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "default_statistics_target=100"

  # ========================================
  # REDIS - Cache & Celery Broker
  # ========================================
  redis:
    image: redis:7-alpine
    container_name: martial_arts_redis
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    restart: always
    networks:
      - martial-arts-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ========================================
  # CELERY WORKER - Background Tasks
  # ========================================
  celery-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    container_name: martial_arts_celery_worker
    command: celery -A celery_app worker -l info -c 4 -Q video_processing,skeleton_extraction,translation,default
    env_file:
      - .env.production
    environment:
      - ENV=production
      - DATABASE_URL=postgresql://martial_user:${DB_PASSWORD}@postgres:5432/martial_arts_prod
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
    volumes:
      - celery-logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: always
    networks:
      - martial-arts-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  # ========================================
  # CELERY BEAT - Scheduled Tasks
  # ========================================
  celery-beat:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    container_name: martial_arts_celery_beat
    command: celery -A celery_app beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    env_file:
      - .env.production
    environment:
      - ENV=production
      - DATABASE_URL=postgresql://martial_user:${DB_PASSWORD}@postgres:5432/martial_arts_prod
      - CELERY_BROKER_URL=redis://redis:6379/1
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: always
    networks:
      - martial-arts-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

# ========================================
# VOLUMES
# ========================================
volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
  nginx-logs:
    driver: local
  backend-logs:
    driver: local
  celery-logs:
    driver: local

# ========================================
# NETWORKS
# ========================================
networks:
  martial-arts-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# ========================================
# NOTES
# ========================================
#
# Before running:
# 1. Create .env.production with all required variables
# 2. Set DB_PASSWORD in .env.production
# 3. Generate SSL certificates (Let's Encrypt):
#    certbot certonly --standalone -d yourdomain.com -d www.yourdomain.com
# 4. Create nginx config files in nginx/conf.d/
#
# Production commands:
# - Start: docker-compose -f docker-compose.prod.yml up -d
# - Stop: docker-compose -f docker-compose.prod.yml down
# - Logs: docker-compose -f docker-compose.prod.yml logs -f [service]
# - Restart service: docker-compose -f docker-compose.prod.yml restart [service]
# - Scale workers: docker-compose -f docker-compose.prod.yml up -d --scale celery-worker=4
#
# Database migrations:
#   docker-compose -f docker-compose.prod.yml exec backend alembic upgrade head
#
# Database backup:
#   docker-compose -f docker-compose.prod.yml exec postgres pg_dump -U martial_user martial_arts_prod > backup.sql
#
# Database restore:
#   docker-compose -f docker-compose.prod.yml exec -T postgres psql -U martial_user martial_arts_prod < backup.sql
#
# ========================================
